# Orchestration Configuration
# This file defines the routing rules for the stateless orchestrator

name: "Order Processing Orchestration"
version: "1.0.0"
description: "Routes events for e-commerce order processing workflow"

# Global orchestrator settings
settings:
  queuePrefix: "order-processing"
  auditEnabled: true
  metricsEnabled: true
  defaultTimeoutMs: 30000

# Routing definitions
routes:
  # Order Creation
  - eventType: "OrderCreated"
    description: "New order submitted by customer"
    defaultTarget: "validation-service-queue"
    enabled: true
    tags:
      - "order"
      - "entry-point"

  # Order Validation
  - eventType: "OrderValidated"
    description: "Order has passed validation"
    defaultTarget: "inventory-service-queue"
    enabled: true
    tags:
      - "order"
      - "validation"

  - eventType: "ValidationFailed"
    description: "Order validation failed"
    defaultTarget: "notification-service-queue"
    enabled: true
    tags:
      - "order"
      - "error"

  # Inventory Management
  - eventType: "InventoryReserved"
    description: "Inventory has been reserved for order"
    # Conditional routing based on customer tier
    conditions:
      - condition: "#context['customerTier'] == 'premium'"
        target: "express-payment-service-queue"
        description: "Premium customers get express payment processing"
        priority: 1
      
      - condition: "#context['orderTotal'] != null && #context['orderTotal'] > 1000"
        target: "fraud-check-service-queue"
        description: "High-value orders require fraud check"
        priority: 2
    
    defaultTarget: "payment-service-queue"
    enabled: true
    tags:
      - "order"
      - "inventory"

  - eventType: "InventoryInsufficient"
    description: "Not enough inventory to fulfill order"
    defaultTarget: "notification-service-queue"
    enabled: true
    tags:
      - "order"
      - "inventory"
      - "error"

  # Fraud Check
  - eventType: "FraudCheckPassed"
    description: "Order passed fraud screening"
    defaultTarget: "payment-service-queue"
    enabled: true
    tags:
      - "order"
      - "fraud"

  - eventType: "FraudCheckFailed"
    description: "Order flagged as potentially fraudulent"
    defaultTarget: "order-cancellation-service-queue"
    enabled: true
    tags:
      - "order"
      - "fraud"
      - "error"

  # Payment Processing
  - eventType: "PaymentSucceeded"
    description: "Payment processed successfully"
    defaultTarget: "fulfillment-service-queue"
    enabled: true
    tags:
      - "order"
      - "payment"

  - eventType: "PaymentFailed"
    description: "Payment processing failed"
    # Conditional routing based on context
    conditions:
      - condition: "#context['inventoryReserved'] == true"
        target: "inventory-rollback-service-queue"
        description: "Rollback inventory if it was reserved"
        priority: 1
      
      - condition: "#context['retryCount'] != null && #context['retryCount'] < 3"
        target: "payment-retry-service-queue"
        description: "Retry payment if under retry limit"
        priority: 2
    
    defaultTarget: "notification-service-queue"
    enabled: true
    tags:
      - "order"
      - "payment"
      - "error"

  # Inventory Rollback
  - eventType: "InventoryReleased"
    description: "Inventory reservation released"
    defaultTarget: "notification-service-queue"
    enabled: true
    tags:
      - "order"
      - "inventory"
      - "compensation"

  # Fulfillment
  - eventType: "FulfillmentCreated"
    description: "Fulfillment order created"
    conditions:
      - condition: "#context['isDigital'] == true"
        target: "digital-delivery-service-queue"
        description: "Digital products use different delivery"
        priority: 1
    
    defaultTarget: "shipping-service-queue"
    enabled: true
    tags:
      - "order"
      - "fulfillment"

  - eventType: "ShipmentCreated"
    description: "Shipping label generated"
    defaultTarget: "notification-service-queue"
    enabled: true
    tags:
      - "order"
      - "shipping"

  - eventType: "DigitalDeliveryComplete"
    description: "Digital product delivered"
    defaultTarget: "notification-service-queue"
    enabled: true
    tags:
      - "order"
      - "digital"

  # Order Cancellation
  - eventType: "OrderCancelled"
    description: "Order has been cancelled"
    conditions:
      - condition: "#context['inventoryReserved'] == true"
        target: "inventory-rollback-service-queue"
        description: "Release inventory if reserved"
        priority: 1
    
    defaultTarget: "notification-service-queue"
    enabled: true
    tags:
      - "order"
      - "cancellation"

  # Notifications
  - eventType: "NotificationSent"
    description: "Customer notification sent"
    # Terminal event - no routing needed
    enabled: false
    tags:
      - "order"
      - "notification"
      - "terminal"
