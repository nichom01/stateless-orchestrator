name: Performance Testing

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'load'
        type: choice
        options:
          - load
          - stress
          - spike
          - all
      deployment_mode:
        description: 'Deployment mode'
        required: false
        default: 'compose'
        type: choice
        options:
          - compose
          - swarm
      duration:
        description: 'Custom test duration (e.g., 10m, 30m)'
        required: false
        type: string
      vus:
        description: 'Maximum virtual users'
        required: false
        type: string
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  pull_request:
    types: [labeled]
    labels:
      - 'performance-test'

env:
  ORCHESTRATOR_URL: http://orchestrator:8080
  EVENTS_PER_REQUEST: 100
  DEPLOYMENT_MODE: ${{ github.event.inputs.deployment_mode || 'compose' }}

jobs:
  load-test:
    name: Load Test
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' && (github.event.inputs.test_type == 'load' || github.event.inputs.test_type == 'all') ||
      github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'performance-test')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start performance test environment
        run: |
          docker compose -f docker-compose.perf.yml up -d localstack prometheus
          echo "Waiting for LocalStack to be ready..."
          sleep 10

      - name: Build orchestrator image
        run: |
          docker compose -f docker-compose.perf.yml build orchestrator

      - name: Start orchestrator
        run: |
          docker compose -f docker-compose.perf.yml up -d orchestrator
          echo "Waiting for orchestrator to be healthy..."
          for i in {1..60}; do
            if docker exec perf-orchestrator curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "Orchestrator is healthy"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "Orchestrator failed to become healthy"
              docker logs perf-orchestrator
              exit 1
            fi
            sleep 2
          done

      - name: Generate test data if needed
        run: |
          mkdir -p perf-tests/test-data
          if [ ! -f perf-tests/test-data/test-data-10k.jsonl ]; then
            node perf-tests/generate-test-data.js 10000 perf-tests/test-data/test-data-10k.jsonl
          fi

      - name: Verify orchestrator connectivity from k6 (Compose)
        if: env.DEPLOYMENT_MODE == 'compose'
        run: |
          echo "Testing connectivity from k6 container..."
          docker compose -f docker-compose.perf.yml run --rm \
            --user root \
            --entrypoint /bin/sh \
            k6 -c "curl -f http://orchestrator:8080/actuator/health || echo 'Health check failed'"

      - name: Verify orchestrator connectivity from k6 (Swarm)
        if: env.DEPLOYMENT_MODE == 'swarm'
        run: |
          echo "Testing connectivity to orchestrator service..."
          docker run --rm --network perf-test_perf-network curlimages/curl:latest \
            curl -f http://orchestrator:8080/actuator/health || echo 'Health check failed'

      - name: Run load test (Compose)
        if: env.DEPLOYMENT_MODE == 'compose'
        run: |
          mkdir -p perf-tests/results
          echo "Running k6 load test with Docker Compose..."
          echo "ORCHESTRATOR_URL=${{ env.ORCHESTRATOR_URL }}"
          echo "EVENTS_PER_REQUEST=${{ env.EVENTS_PER_REQUEST }}"
          # Use docker to set permissions on the results directory
          docker compose -f docker-compose.perf.yml run --rm \
            --user root \
            --entrypoint /bin/sh \
            -v ${{ github.workspace }}/perf-tests/results:/results \
            k6 -c "chmod 777 /results || true"
          docker compose -f docker-compose.perf.yml run --rm \
            --user root \
            -e ORCHESTRATOR_URL=${{ env.ORCHESTRATOR_URL }} \
            -e EVENTS_PER_REQUEST=${{ env.EVENTS_PER_REQUEST }} \
            -v ${{ github.workspace }}/perf-tests/results:/results \
            k6 run \
            --out json=/results/load-test-results.json \
            --summary-export=/results/load-test-summary.json \
            /scripts/load-test.js 2>&1 || {
              echo "k6 test failed, checking logs..."
              docker compose -f docker-compose.perf.yml logs k6 || true
              exit 1
            }
        continue-on-error: true

      - name: Run load test (Swarm)
        if: env.DEPLOYMENT_MODE == 'swarm'
        run: |
          mkdir -p perf-tests/results
          echo "Running k6 load test with Docker Swarm..."
          echo "ORCHESTRATOR_URL=${{ env.ORCHESTRATOR_URL }}"
          echo "EVENTS_PER_REQUEST=${{ env.EVENTS_PER_REQUEST }}"
          TIMESTAMP=$(date +%s)
          SERVICE_NAME="perf-test_k6_load_${TIMESTAMP}"
          docker service create \
            --name "${SERVICE_NAME}" \
            --network perf-test_perf-network \
            --mount type=bind,source=${{ github.workspace }}/perf-tests,target=/scripts \
            --mount type=bind,source=${{ github.workspace }}/perf-tests/results,target=/results \
            -e ORCHESTRATOR_URL=${{ env.ORCHESTRATOR_URL }} \
            -e EVENTS_PER_REQUEST=${{ env.EVENTS_PER_REQUEST }} \
            --restart-condition none \
            grafana/k6:latest \
            run --out json=/results/load-test-results.json --summary-export=/results/load-test-summary.json /scripts/load-test.js
          
          # Wait for service to complete
          echo "Waiting for k6 service to complete..."
          for i in {1..300}; do
            SERVICE_STATE=$(docker service ps "${SERVICE_NAME}" --format "{{.CurrentState}}" --no-trunc 2>/dev/null | head -n1 || echo "")
            if [ -z "$SERVICE_STATE" ] || echo "$SERVICE_STATE" | grep -q "Complete\|Shutdown\|Failed"; then
              echo "Service completed"
              break
            fi
            if [ $i -eq 300 ]; then
              echo "Service timeout after 5 minutes"
              break
            fi
            sleep 1
          done
          
          # Get logs
          echo "Collecting k6 logs..."
          docker service logs "${SERVICE_NAME}" 2>&1 || true
          
          # Check exit code
          TASK_ID=$(docker service ps "${SERVICE_NAME}" --format "{{.ID}}" --filter "desired-state=shutdown" | head -n1)
          if [ -n "$TASK_ID" ]; then
            EXIT_CODE=$(docker inspect --format '{{.Status.ContainerStatus.ExitCode}}' "$TASK_ID" 2>/dev/null || echo "0")
            if [ "$EXIT_CODE" != "0" ]; then
              echo "k6 test failed with exit code: $EXIT_CODE"
              exit 1
            fi
          fi
          
          # Cleanup
          docker service rm "${SERVICE_NAME}" || true
        continue-on-error: true

      - name: Collect orchestrator logs (Compose)
        if: always() && env.DEPLOYMENT_MODE == 'compose'
        run: |
          docker logs perf-orchestrator > perf-tests/results/orchestrator-logs.txt 2>&1 || true

      - name: Collect orchestrator logs (Swarm)
        if: always() && env.DEPLOYMENT_MODE == 'swarm'
        run: |
          docker service logs perf-test_orchestrator --tail 1000 > perf-tests/results/orchestrator-logs.txt 2>&1 || true

      - name: Collect queue statistics
        if: always()
        run: |
          ./scripts/queue-stats.sh > perf-tests/results/queue-stats.txt 2>&1 || true

      - name: Generate HTML report
        if: always()
        run: |
          node perf-tests/scripts/generate-report.js \
            --input perf-tests/results/load-test-results.json \
            --output perf-tests/results/load-test-report.html \
            --type load || echo "Report generation skipped"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: |
            perf-tests/results/
          retention-days: 30

      - name: Cleanup (Compose)
        if: always() && env.DEPLOYMENT_MODE == 'compose'
        run: |
          docker compose -f docker-compose.perf.yml down -v || true

      - name: Cleanup (Swarm)
        if: always() && env.DEPLOYMENT_MODE == 'swarm'
        run: |
          docker stack rm perf-test || true
          docker service rm $(docker service ls -q --filter "name=perf-test") 2>/dev/null || true
          sleep 5

  stress-test:
    name: Stress Test
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' && (github.event.inputs.test_type == 'stress' || github.event.inputs.test_type == 'all') ||
      github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'performance-test')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Initialize Docker Swarm (if using swarm mode)
        if: env.DEPLOYMENT_MODE == 'swarm'
        run: |
          docker swarm init || echo "Swarm already initialized"

      - name: Build orchestrator image
        run: |
          docker build -t stateless-orchestrator:latest .

      - name: Start performance test environment (Compose)
        if: env.DEPLOYMENT_MODE == 'compose'
        run: |
          docker compose -f docker-compose.perf.yml up -d localstack prometheus
          echo "Waiting for LocalStack to be ready..."
          sleep 10
          docker compose -f docker-compose.perf.yml build orchestrator
          docker compose -f docker-compose.perf.yml up -d orchestrator

      - name: Start performance test environment (Swarm)
        if: env.DEPLOYMENT_MODE == 'swarm'
        run: |
          docker stack deploy -c docker-compose.swarm.yml perf-test
          echo "Waiting for services to start..."
          sleep 15

      - name: Wait for orchestrator to be healthy (Compose)
        if: env.DEPLOYMENT_MODE == 'compose'
        run: |
          echo "Waiting for orchestrator to be healthy..."
          for i in {1..60}; do
            if docker exec perf-orchestrator curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "Orchestrator is healthy"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "Orchestrator failed to become healthy"
              docker logs perf-orchestrator
              exit 1
            fi
            sleep 2
          done

      - name: Wait for orchestrator to be healthy (Swarm)
        if: env.DEPLOYMENT_MODE == 'swarm'
        run: |
          echo "Waiting for orchestrator service to be healthy..."
          for i in {1..60}; do
            if docker service ps perf-test_orchestrator --format "{{.CurrentState}}" | grep -q "Running"; then
              TASK_ID=$(docker service ps perf-test_orchestrator --format "{{.ID}}" --filter "desired-state=running" | head -n1)
              if [ -n "$TASK_ID" ]; then
                CONTAINER_ID=$(docker inspect --format '{{.Status.ContainerStatus.ContainerID}}' $TASK_ID 2>/dev/null || echo "")
                if [ -n "$CONTAINER_ID" ]; then
                  if docker exec $CONTAINER_ID curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
                    echo "Orchestrator is healthy"
                    break
                  fi
                fi
              fi
            fi
            if [ $i -eq 60 ]; then
              echo "Orchestrator failed to become healthy"
              docker service logs perf-test_orchestrator --tail 50
              exit 1
            fi
            sleep 2
          done

      - name: Generate test data if needed
        run: |
          mkdir -p perf-tests/test-data
          if [ ! -f perf-tests/test-data/test-data-50k.jsonl ]; then
            node perf-tests/generate-test-data.js 50000 perf-tests/test-data/test-data-50k.jsonl
          fi

      - name: Run stress test (Compose)
        if: env.DEPLOYMENT_MODE == 'compose'
        run: |
          mkdir -p perf-tests/results
          docker compose -f docker-compose.perf.yml run --rm \
            --user root \
            --entrypoint /bin/sh \
            -v ${{ github.workspace }}/perf-tests/results:/results \
            k6 -c "chmod 777 /results || true"
          docker compose -f docker-compose.perf.yml run --rm \
            --user root \
            -e ORCHESTRATOR_URL=${{ env.ORCHESTRATOR_URL }} \
            -e EVENTS_PER_REQUEST=${{ env.EVENTS_PER_REQUEST }} \
            -v ${{ github.workspace }}/perf-tests/results:/results \
            k6 run \
            --out json=/results/stress-test-results.json \
            --summary-export=/results/stress-test-summary.json \
            /scripts/stress-test.js
        continue-on-error: true

      - name: Run stress test (Swarm)
        if: env.DEPLOYMENT_MODE == 'swarm'
        run: |
          mkdir -p perf-tests/results
          TIMESTAMP=$(date +%s)
          SERVICE_NAME="perf-test_k6_stress_${TIMESTAMP}"
          docker service create \
            --name "${SERVICE_NAME}" \
            --network perf-test_perf-network \
            --mount type=bind,source=${{ github.workspace }}/perf-tests,target=/scripts \
            --mount type=bind,source=${{ github.workspace }}/perf-tests/results,target=/results \
            -e ORCHESTRATOR_URL=${{ env.ORCHESTRATOR_URL }} \
            -e EVENTS_PER_REQUEST=${{ env.EVENTS_PER_REQUEST }} \
            --restart-condition none \
            grafana/k6:latest \
            run --out json=/results/stress-test-results.json --summary-export=/results/stress-test-summary.json /scripts/stress-test.js
          
          # Wait for service to complete
          echo "Waiting for k6 service to complete..."
          for i in {1..600}; do
            SERVICE_STATE=$(docker service ps "${SERVICE_NAME}" --format "{{.CurrentState}}" --no-trunc 2>/dev/null | head -n1 || echo "")
            if [ -z "$SERVICE_STATE" ] || echo "$SERVICE_STATE" | grep -q "Complete\|Shutdown\|Failed"; then
              echo "Service completed"
              break
            fi
            if [ $i -eq 600 ]; then
              echo "Service timeout after 10 minutes"
              break
            fi
            sleep 1
          done
          
          # Get logs
          echo "Collecting k6 logs..."
          docker service logs "${SERVICE_NAME}" 2>&1 || true
          
          # Check exit code
          TASK_ID=$(docker service ps "${SERVICE_NAME}" --format "{{.ID}}" --filter "desired-state=shutdown" | head -n1)
          if [ -n "$TASK_ID" ]; then
            EXIT_CODE=$(docker inspect --format '{{.Status.ContainerStatus.ExitCode}}' "$TASK_ID" 2>/dev/null || echo "0")
            if [ "$EXIT_CODE" != "0" ]; then
              echo "k6 stress test failed with exit code: $EXIT_CODE"
              exit 1
            fi
          fi
          
          # Cleanup
          docker service rm "${SERVICE_NAME}" || true
        continue-on-error: true

      - name: Collect orchestrator logs (Compose)
        if: always() && env.DEPLOYMENT_MODE == 'compose'
        run: |
          docker logs perf-orchestrator > perf-tests/results/orchestrator-logs-stress.txt 2>&1 || true

      - name: Collect orchestrator logs (Swarm)
        if: always() && env.DEPLOYMENT_MODE == 'swarm'
        run: |
          docker service logs perf-test_orchestrator --tail 1000 > perf-tests/results/orchestrator-logs-stress.txt 2>&1 || true

      - name: Collect queue statistics
        if: always()
        run: |
          ./scripts/queue-stats.sh > perf-tests/results/queue-stats-stress.txt 2>&1 || true

      - name: Generate HTML report
        if: always()
        run: |
          node perf-tests/scripts/generate-report.js \
            --input perf-tests/results/stress-test-results.json \
            --output perf-tests/results/stress-test-report.html \
            --type stress || echo "Report generation skipped"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stress-test-results
          path: |
            perf-tests/results/
          retention-days: 30

      - name: Cleanup (Compose)
        if: always() && env.DEPLOYMENT_MODE == 'compose'
        run: |
          docker compose -f docker-compose.perf.yml down -v || true

      - name: Cleanup (Swarm)
        if: always() && env.DEPLOYMENT_MODE == 'swarm'
        run: |
          docker stack rm perf-test || true
          docker service rm $(docker service ls -q --filter "name=perf-test") 2>/dev/null || true
          sleep 5

  spike-test:
    name: Spike Test
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' && (github.event.inputs.test_type == 'spike' || github.event.inputs.test_type == 'all')
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Initialize Docker Swarm (if using swarm mode)
        if: env.DEPLOYMENT_MODE == 'swarm'
        run: |
          docker swarm init || echo "Swarm already initialized"

      - name: Build orchestrator image
        run: |
          docker build -t stateless-orchestrator:latest .

      - name: Start performance test environment (Compose)
        if: env.DEPLOYMENT_MODE == 'compose'
        run: |
          docker compose -f docker-compose.perf.yml up -d localstack prometheus
          echo "Waiting for LocalStack to be ready..."
          sleep 10
          docker compose -f docker-compose.perf.yml build orchestrator
          docker compose -f docker-compose.perf.yml up -d orchestrator

      - name: Start performance test environment (Swarm)
        if: env.DEPLOYMENT_MODE == 'swarm'
        run: |
          docker stack deploy -c docker-compose.swarm.yml perf-test
          echo "Waiting for services to start..."
          sleep 15

      - name: Wait for orchestrator to be healthy (Compose)
        if: env.DEPLOYMENT_MODE == 'compose'
        run: |
          echo "Waiting for orchestrator to be healthy..."
          for i in {1..60}; do
            if docker exec perf-orchestrator curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "Orchestrator is healthy"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "Orchestrator failed to become healthy"
              docker logs perf-orchestrator
              exit 1
            fi
            sleep 2
          done

      - name: Wait for orchestrator to be healthy (Swarm)
        if: env.DEPLOYMENT_MODE == 'swarm'
        run: |
          echo "Waiting for orchestrator service to be healthy..."
          for i in {1..60}; do
            if docker service ps perf-test_orchestrator --format "{{.CurrentState}}" | grep -q "Running"; then
              TASK_ID=$(docker service ps perf-test_orchestrator --format "{{.ID}}" --filter "desired-state=running" | head -n1)
              if [ -n "$TASK_ID" ]; then
                CONTAINER_ID=$(docker inspect --format '{{.Status.ContainerStatus.ContainerID}}' $TASK_ID 2>/dev/null || echo "")
                if [ -n "$CONTAINER_ID" ]; then
                  if docker exec $CONTAINER_ID curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
                    echo "Orchestrator is healthy"
                    break
                  fi
                fi
              fi
            fi
            if [ $i -eq 60 ]; then
              echo "Orchestrator failed to become healthy"
              docker service logs perf-test_orchestrator --tail 50
              exit 1
            fi
            sleep 2
          done

      - name: Run spike test (Compose)
        if: env.DEPLOYMENT_MODE == 'compose'
        run: |
          mkdir -p perf-tests/results
          docker compose -f docker-compose.perf.yml run --rm \
            --user root \
            --entrypoint /bin/sh \
            -v ${{ github.workspace }}/perf-tests/results:/results \
            k6 -c "chmod 777 /results || true"
          docker compose -f docker-compose.perf.yml run --rm \
            --user root \
            -e ORCHESTRATOR_URL=${{ env.ORCHESTRATOR_URL }} \
            -e EVENTS_PER_REQUEST=${{ env.EVENTS_PER_REQUEST }} \
            -v ${{ github.workspace }}/perf-tests/results:/results \
            k6 run \
            --out json=/results/spike-test-results.json \
            --summary-export=/results/spike-test-summary.json \
            /scripts/spike-test.js
        continue-on-error: true

      - name: Run spike test (Swarm)
        if: env.DEPLOYMENT_MODE == 'swarm'
        run: |
          mkdir -p perf-tests/results
          TIMESTAMP=$(date +%s)
          SERVICE_NAME="perf-test_k6_spike_${TIMESTAMP}"
          docker service create \
            --name "${SERVICE_NAME}" \
            --network perf-test_perf-network \
            --mount type=bind,source=${{ github.workspace }}/perf-tests,target=/scripts \
            --mount type=bind,source=${{ github.workspace }}/perf-tests/results,target=/results \
            -e ORCHESTRATOR_URL=${{ env.ORCHESTRATOR_URL }} \
            -e EVENTS_PER_REQUEST=${{ env.EVENTS_PER_REQUEST }} \
            --restart-condition none \
            grafana/k6:latest \
            run --out json=/results/spike-test-results.json --summary-export=/results/spike-test-summary.json /scripts/spike-test.js
          
          # Wait for service to complete
          echo "Waiting for k6 service to complete..."
          for i in {1..300}; do
            SERVICE_STATE=$(docker service ps "${SERVICE_NAME}" --format "{{.CurrentState}}" --no-trunc 2>/dev/null | head -n1 || echo "")
            if [ -z "$SERVICE_STATE" ] || echo "$SERVICE_STATE" | grep -q "Complete\|Shutdown\|Failed"; then
              echo "Service completed"
              break
            fi
            if [ $i -eq 300 ]; then
              echo "Service timeout after 5 minutes"
              break
            fi
            sleep 1
          done
          
          # Get logs
          echo "Collecting k6 logs..."
          docker service logs "${SERVICE_NAME}" 2>&1 || true
          
          # Check exit code
          TASK_ID=$(docker service ps "${SERVICE_NAME}" --format "{{.ID}}" --filter "desired-state=shutdown" | head -n1)
          if [ -n "$TASK_ID" ]; then
            EXIT_CODE=$(docker inspect --format '{{.Status.ContainerStatus.ExitCode}}' "$TASK_ID" 2>/dev/null || echo "0")
            if [ "$EXIT_CODE" != "0" ]; then
              echo "k6 spike test failed with exit code: $EXIT_CODE"
              exit 1
            fi
          fi
          
          # Cleanup
          docker service rm "${SERVICE_NAME}" || true
        continue-on-error: true

      - name: Collect orchestrator logs (Compose)
        if: always() && env.DEPLOYMENT_MODE == 'compose'
        run: |
          docker logs perf-orchestrator > perf-tests/results/orchestrator-logs-spike.txt 2>&1 || true

      - name: Collect orchestrator logs (Swarm)
        if: always() && env.DEPLOYMENT_MODE == 'swarm'
        run: |
          docker service logs perf-test_orchestrator --tail 1000 > perf-tests/results/orchestrator-logs-spike.txt 2>&1 || true

      - name: Generate HTML report
        if: always()
        run: |
          node perf-tests/scripts/generate-report.js \
            --input perf-tests/results/spike-test-results.json \
            --type spike || echo "Report generation skipped"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spike-test-results
          path: |
            perf-tests/results/
          retention-days: 30

      - name: Cleanup (Compose)
        if: always() && env.DEPLOYMENT_MODE == 'compose'
        run: |
          docker compose -f docker-compose.perf.yml down -v || true

      - name: Cleanup (Swarm)
        if: always() && env.DEPLOYMENT_MODE == 'swarm'
        run: |
          docker stack rm perf-test || true
          docker service rm $(docker service ls -q --filter "name=perf-test") 2>/dev/null || true
          sleep 5
